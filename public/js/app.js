"use strict";var _get=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,n,r)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(r):void 0},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function wrt(e){console.log(e)}var Modal=function(){function e(t){_classCallCheck(this,e),this.modal=t,this.docBody=document.querySelector("body")}return _createClass(e,[{key:"closeAnimEnd",value:function(){this.modal.classList.contains("fadeIn")?(this.modal.classList.remove("fadeIn"),this.docBody.classList.add("modal-opened")):this.modal.classList.contains("fadeOut")&&(this.modal.style.display="none",this.modal.classList.remove("fadeOut"),this.docBody.classList.remove("modal-opened"))}},{key:"open",value:function(){this.modal.style.display="flex",this.modal.classList.remove("fadeOut"),this.modal.classList.add("fadeIn")}},{key:"close",value:function(){this.modal.classList.remove("fadeIn"),this.modal.classList.add("fadeOut")}},{key:"init",value:function(){var e=this;this.modal.querySelector(".js-modal-close").addEventListener("click",function(){e.close()}),this.modal.addEventListener("webkitAnimationEnd",function(){e.closeAnimEnd()}),this.modal.addEventListener("animationend",function(){e.closeAnimEnd()}),window.addEventListener("click",function(t){t.target===e.modal&&e.close()})}}]),e}(),Server=function(){function e(){_classCallCheck(this,e),this.art=null}return _createClass(e,[{key:"getFeed",value:function(){return fetch("./src/js/feed.json",{method:"GET"})}},{key:"getCard",value:function(e){return fetch("./src/js/feed.json",{method:"GET"}).then(function(e){return e.json()}).then(function(t){return t.find(function(t,n){if(t.id===Number(e))return t})})}},{key:"updArtState",value:function(e,t){this.art=null===e?null:{status:!0,id:t}}}]),e}(),connection=new Server,ImageSidebar=function(){function e(t){_classCallCheck(this,e),this.sidebar=document.querySelector("."+t.sidebar),this.art=document.querySelector("."+t.art),this.descr=document.querySelector("."+t.descr),this.state=!0}return _createClass(e,[{key:"toggle",value:function(){this.state?(this.descr.style.transform="translateX(600px)",this.art.style.transform="translateX(0px)",this.state=!1):(this.descr.style.transform="translateX(0px)",this.art.style.transform="translateX(-600px)",this.state=!0)}}]),e}(),imageSidebar=new ImageSidebar({sidebar:"image-sidebar",art:"image-art",descr:"image-infoblock"}),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=document.querySelectorAll(".js-image-sidebar-toggle")[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var btn=_step.value;btn.addEventListener("click",function(){imageSidebar.toggle()})}}catch(e){_didIteratorError=!0,_iteratorError=e}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}var ImageLoader=function(){function e(t){_classCallCheck(this,e),this.dropArea=t,this.dropAreaInner=this.dropArea.firstElementChild,this.inputReplacer=document.querySelector(".js-upload-input-replacer"),this.input=document.querySelector(".js-upload-input"),this.preview=document.querySelector(".js-upload-image-preview"),this.modalOpenBtn=document.querySelector(".js-upload-pic-btn"),this.modalUploadCancelBtn=document.querySelector(".js-upload-cancel"),this.modalUploadAcceptBtn=document.querySelector(".js-upload-accept"),this.modal=new Modal(document.querySelector(".js-upload-modal")),this.modal.init()}return _createClass(e,[{key:"getPreviewImg",value:function(e){if(e.length&&-1!==e[0].type.indexOf("image"))return URL.createObjectURL(e[0])}},{key:"showPreviewImg",value:function(e){var t=document.createElement("img");t.src=e,t.addEventListener("load",function(e){URL.revokeObjectURL(e.target.src)}),this.removePreviewImg(),this.preview.appendChild(t)}},{key:"removePreviewImg",value:function(){this.preview.textContent=""}},{key:"uploadCancel",value:function(){this.modal.close(),this.removePreviewImg()}},{key:"init",value:function(){var e=this;this.input.addEventListener("change",function(t){t.preventDefault();var n=e.getPreviewImg(t.currentTarget.files);e.showPreviewImg(n)}),this.dropArea.addEventListener("drop",function(t){t.preventDefault();var n=e.getPreviewImg(t.dataTransfer.files);e.showPreviewImg(n),e.dropArea.classList.remove("upload-modal__drop-area_dragover")}),this.dropArea.addEventListener("dragover",function(t){t.preventDefault(),t.target!==e.dropArea&&t.target!==e.dropAreaInner||e.dropArea.classList.add("upload-modal__drop-area_dragover")}),this.inputReplacer.addEventListener("click",function(){e.input.click()}),this.modalOpenBtn.addEventListener("click",function(t){e.modal.open()}),this.modalUploadCancelBtn.addEventListener("click",function(t){e.uploadCancel()})}}]),e}(),dropArea=new ImageLoader(document.querySelector(".js-drop-area"));dropArea.init();var Feed=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"createStat",value:function(e,t){var n=document.createElement("td"),r=document.createElement("p");r.classList.add("stat","js-stat-likes"),n.appendChild(r);var i=document.createElement("span");i.classList.add(e),r.appendChild(i);var a=document.createElement("span");return a.textContent=t,r.appendChild(a),n}},{key:"createCard",value:function(t){var n=document.createElement("div");n.classList.add("card-thumbnail"),n.dataset.id=t.id;var r=document.createElement("div");r.classList.add("card-thumbnail__overlay"),n.appendChild(r);var i=document.createElement("div");i.classList.add("card-thumbnail__stats","stats"),n.appendChild(i);var a=document.createElement("table");i.appendChild(a);var o=document.createElement("tr");o.appendChild(e.createStat("icon-heart",t.likes)),o.appendChild(e.createStat("icon-bubble",t.comments)),a.appendChild(o.cloneNode(!0)),o.textContent="",o.appendChild(e.createStat("icon-eye",t.seen)),o.appendChild(e.createStat("icon-pencil",t.art)),a.appendChild(o);var s=document.createElement("img");return s.src=t.src,n.appendChild(s),n}},{key:"renderFeed",value:function(t){var n=0,r=document.createDocumentFragment(),i=!0,a=!1,o=void 0;try{for(var s,c=t[Symbol.iterator]();!(i=(s=c.next()).done);i=!0){var l=s.value;if(0===n){var d=document.createElement("div");d.classList.add("row"),r.appendChild(d)}var u=r.lastElementChild,h=document.createElement("div");h.classList.add("col-sm-4"),u.appendChild(h),h.appendChild(e.createCard(l)),3==++n&&(n=0)}}catch(e){a=!0,o=e}finally{try{!i&&c.return&&c.return()}finally{if(a)throw o}}e.feed.textContent="",e.feed.appendChild(r)}},{key:"updFeed",value:function(){connection.getFeed().then(function(e){return e.json()}).then(function(t){return e.renderFeed(t)})}},{key:"feed",get:function(){return document.querySelector(".js-feed")}}]),e}();Feed.updFeed();var Art=function(){function e(t,n){_classCallCheck(this,e),this.imgContainer=t,this.img=t.querySelector("img"),this.canvas=document.createElement("canvas"),this.canvas.height=this.img.clientHeight,this.canvas.width=this.img.clientWidth,this.ctx=this.canvas.getContext("2d"),this.brushColorInput=n.querySelector(".art-controls-color"),this.brushWidthInput=n.querySelector(".art-controls-size"),this.brushColor=this.brushColorInput.value,this.brushWidth=this.brushWidthInput.value,this.ctx.lineJoin="round",this.ctx.lineCap="round",this.shiftPressed=0,this.needsRepaint=!1,this.curves=[],this.mouseHolded=0}return _createClass(e,[{key:"repaint",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.img,0,0,this.canvas.width,this.canvas.height);var e=!0,t=!1,n=void 0;try{for(var r,i=this.curves[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){var a=r.value;this.circle(a[0]),this.smoothCurve(a)}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}}},{key:"circle",value:function(e){this.ctx.beginPath(),this.ctx.arc(e[0],e[1],e[3]/2,0,2*Math.PI),this.ctx.save(),this.ctx.fillStyle=e[2],this.ctx.lineWidth=e[3],this.ctx.fill(),this.ctx.restore()}},{key:"smoothCurveBetween",value:function(e,t){var n=(e[0]+t[0])/2,r=(e[1]+t[1])/2;this.ctx.quadraticCurveTo(e[0],e[1],n,r)}},{key:"smoothCurve",value:function(e){this.ctx.beginPath(),this.ctx.moveTo(e[0][0],e[0][1]);for(var t=1;t<e.length-1;t++)this.smoothCurveBetween(e[t],e[t+1]);this.ctx.strokeStyle=e[e.length-1][2],this.ctx.lineWidth=e[e.length-1][3],this.ctx.stroke()}},{key:"tick",value:function(){var e=this;this.shiftPressedControl(),this.needsRepaint&&(this.repaint(),this.needsRepaint=!1),window.requestAnimationFrame(function(){e.tick()})}},{key:"shiftPressedControl",value:function(){var e=this;document.addEventListener("keydown",function(t){t.shiftKey?e.shiftPressed=1:e.shiftPressed=0}),document.addEventListener("keyup",function(t){t.shiftKey?e.shiftPressed=1:e.shiftPressed=0})}},{key:"checkBoundaries",value:function(e){return e!==this.canvas?0:1}},{key:"init",value:function(){var e=this;this.imgContainer.textContent="",this.ctx.drawImage(this.img,0,0,this.canvas.width,this.canvas.height),this.imgContainer.appendChild(this.canvas),this.shiftPressedControl(),this.tick(),window.addEventListener("resize",function(){e.ctx.lineJoin="round",e.ctx.lineCap="round",e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height)}),this.canvas.addEventListener("mousedown",function(t){t.preventDefault(),e.mouseHolded=1;var n=[];n.push([t.offsetX,t.offsetY,e.brushColor,e.brushWidth]),e.curves.push(n),e.needsRepaint=!0}),document.addEventListener("mouseup",function(){e.mouseHolded=0}),this.canvas.addEventListener("mousemove",function(t){t.preventDefault(),e.mouseHolded&&(e.curves[e.curves.length-1].push([t.offsetX,t.offsetY,e.brushColor,e.brushWidth]),e.needsRepaint=!0)}),this.canvas.addEventListener("dblclick",function(t){t.preventDefault(),e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height),e.ctx.drawImage(e.img,0,0,e.canvas.width,e.canvas.height),e.curves=[]}),this.brushColorInput.addEventListener("change",function(t){e.brushColor=t.target.value}),this.brushWidthInput.addEventListener("change",function(t){e.brushWidth=t.target.value})}}]),e}(),ShowPicModal=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.pic=e.querySelector(".js-image-natural"),n.likes=e.querySelector(".js-image-like-counter"),n.comments=e.querySelector(".js-image-comment-counter"),n.seen=e.querySelector(".js-image-seen-counter"),n.art=e.querySelector(".js-art-counter"),n.author=e.querySelector(".js-image-author"),n.postDate=e.querySelector(".js-image-date"),n.tags=e.querySelector(".js-image-hashtags"),n.commentsList=e.querySelector(".image-comments"),n.description=e.querySelector(".js-image-description"),n}return _inherits(t,Modal),_createClass(t,[{key:"renderComment",value:function(e,t){var n=document.createElement("div");n.classList.add("image-comment");var r=document.createElement("span");r.classList.add("image-comment-author"),r.textContent=e+": ",n.appendChild(r);var i=document.createElement("span");return i.classList.add("image-comment-body"),i.textContent=t,n.appendChild(i),n}},{key:"updateModalData",value:function(e){var t=this;return connection.getCard(e.dataset.id).then(function(e){t.pic.textContent="";var n=document.createElement("img");return n.src=e.src,t.pic.appendChild(n),e}).then(function(e){return t.likes.textContent=e.likes,t.comments.textContent=e.comments,t.seen.textContent=e.seen,t.art.textContent=e.art,e}).then(function(e){t.author.textContent=e.author,t.postDate.textContent=e.timestamp,t.description.textContent=e.description;var n=!0,r=!1,i=void 0;try{for(var a,o=e.tags[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var s=a.value,c=document.createElement("span");c.textContent="#"+s,t.tags.appendChild(c)}}catch(e){r=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}var l=!0,d=!1,u=void 0;try{for(var h,m=e.commentsList[Symbol.iterator]();!(l=(h=m.next()).done);l=!0){var p=h.value;t.commentsList.appendChild(t.renderComment(p.author,p.body))}}catch(e){d=!0,u=e}finally{try{!l&&m.return&&m.return()}finally{if(d)throw u}}})}},{key:"showPic",value:function(e){var t=this;this.id=e.dataset.id,this.updateModalData(e).then(function(){t.open()})}},{key:"open",value:function(){this.img=this.pic.querySelector("img"),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"open",this).call(this)}},{key:"close",value:function(){this.pic.textContent="",this.likes.textContent="",this.comments.textContent="",this.seen.textContent="",this.art.textContent="",this.author.textContent="",this.postDate.textContent="",this.tags.textContent="",this.commentsList.textContent="",this.description.textContent="",_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"close",this).call(this)}},{key:"init",value:function(){var e=this;document.querySelector(".js-art-on").addEventListener("click",function(t){var n=e.pic,r=e.modal.querySelector(".image-art");new Art(n,r).init(),connection.updArtState(!0,e.id)}),document.querySelector(".js-art-off").addEventListener("click",function(t){e.pic.textContent="",e.pic.appendChild(e.img),connection.updArtState(null)}),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"init",this).call(this)}}]),t}(),showPicModal=new ShowPicModal(document.querySelector(".js-show-pic-modal"));showPicModal.init(),document.querySelector(".js-feed").addEventListener("click",function(e){var t=!0,n=!1,r=void 0;try{for(var i,a=e.path[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;if(o.classList.contains("card-thumbnail")){showPicModal.showPic(o);break}if("BODY"===o.tagName)break}}catch(e){n=!0,r=e}finally{try{!t&&a.return&&a.return()}finally{if(n)throw r}}});